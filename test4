# SEI-SEIR dengue model with climate-dependent parameters

import numpy as np
import pandas as pd
from scipy.integrate import solve_ivp
from scipy.interpolate import interp1d
from sklearn.metrics import r2_score, mean_squared_error, mean_absolute_error
import matplotlib.pyplot as plt

# load data ----
df = pd.read_csv("data/processed/dengue_data_cleaned.csv")

# aggregate by week ----
df = df.groupby(['year', 'week']).agg({
    'total_cases': 'sum',
    'current_temperature': 'mean',
    'current_precipitation': 'mean',
    'current_specific_humidity': 'mean'
}).reset_index()

df = df.sort_values(['year', 'week']).reset_index(drop=True)
n_weeks = len(df)

# parameters ----
N_h = 321992 + 500000  # total human population (San Juan + Iquitos)
eta = 1.0              # recovery rate: 1/7 days = 1 week (for weekly time scale)
delta = 1.0            # human incubation rate: ~1 week

# climate-dependent rate functions ----
def mosquito_death_rate(T, H):
    """μ(T,H): mosquito mortality rate (per week)"""
    # mortality decreases with temperature, increases with low humidity
    mu = 0.5 + 0.1 * (30 - T) / 10  # baseline mortality
    mu = mu * (1.2 - 0.2 * H / 100)  # humidity adjustment
    return np.clip(mu, 0.3, 2.0)

def carrying_capacity(T, H, R):
    """K(T,H,R): maximum mosquito population"""
    # increases with temperature (up to ~30°C), humidity, and rainfall
    temp_effect = np.exp(-((T - 28)**2) / 50)  # optimal ~28°C
    precip_effect = np.tanh(R / 50)            # saturates at high rainfall
    humidity_effect = H / 100
    K = N_h * (0.5 + 2.0 * temp_effect * precip_effect * humidity_effect)
    return np.clip(K, 0.1 * N_h, 3.0 * N_h)

def egg_development_rate(T, K_current, N_m_current):
    """EFD(T): egg-to-adult development rate"""
    # development increases with temperature
    # limited by carrying capacity
    base_rate = 0.1 * np.exp(0.05 * (T - 20))
    capacity_factor = max(0, 1 - N_m_current / K_current)
    return base_rate * capacity_factor

def biting_rate(T):
    """a(T): mosquito biting rate (per week)"""
    # increases with temperature
    return np.clip(0.1 + 0.02 * T, 0.2, 1.5)

def prob_mosquito_infection(T):
    """pMI(T): probability mosquito gets infected per bite"""
    # transmission efficiency increases with temperature
    return np.clip(0.3 + 0.01 * T, 0.3, 0.9)

def prob_human_infection(T):
    """b(T): probability human gets infected per bite"""
    return np.clip(0.3 + 0.01 * T, 0.3, 0.9)

def parasite_development_rate(T):
    """PDR(T): extrinsic incubation period rate = 1/EIP"""
    # EIP decreases with temperature (faster development)
    EIP_days = np.clip(21 - 0.5 * T, 7, 14)
    return 7 / EIP_days  # convert to per-week rate

# interpolate climate data ----
temp_interp = interp1d(np.arange(n_weeks), df['current_temperature'].values, 
                       kind='linear', fill_value='extrapolate')
humid_interp = interp1d(np.arange(n_weeks), df['current_specific_humidity'].values, 
                        kind='linear', fill_value='extrapolate')
precip_interp = interp1d(np.arange(n_weeks), df['current_precipitation'].values, 
                         kind='linear', fill_value='extrapolate')

# ODE system ----
def sei_seir_model(t, y):
    """
    SEI-SEIR model equations
    
    State vector y = [S_m, E_m, I_m, S_h, E_h, I_h, R_h]
    
    Mosquito compartments (m):
      S_m: susceptible mosquitoes
      E_m: exposed mosquitoes
      I_m: infected mosquitoes
    
    Human compartments (h):
      S_h: susceptible humans
      E_h: exposed humans
      I_h: infected humans
      R_h: recovered humans
    """
    S_m, E_m, I_m, S_h, E_h, I_h, R_h = y
    
    # get current climate values ----
    T = float(temp_interp(t))
    H = float(humid_interp(t))
    R = float(precip_interp(t))
    
    # calculate rate parameters ----
    mu = mosquito_death_rate(T, H)
    K = carrying_capacity(T, H, R)
    N_m = S_m + E_m + I_m
    EFD = egg_development_rate(T, K, N_m)
    a = biting_rate(T)
    pMI = prob_mosquito_infection(T)
    b = prob_human_infection(T)
    PDR = parasite_development_rate(T)
    
    # force of infection ----
    lambda_m = a * pMI * I_h / N_h  # mosquito infection rate
    lambda_h = a * b * I_m / N_h     # human infection rate
    
    # mosquito equations (SEI) ----
    dS_m = EFD - lambda_m * S_m - mu * S_m
    dE_m = lambda_m * S_m - PDR * E_m - mu * E_m
    dI_m = PDR * E_m - mu * I_m
    
    # human equations (SEIR) ----
    dS_h = -lambda_h * S_h
    dE_h = lambda_h * S_h - delta * E_h
    dI_h = delta * E_h - eta * I_h
    dR_h = eta * I_h
    
    return [dS_m, dE_m, dI_m, dS_h, dE_h, dI_h, dR_h]

# initial conditions ----
# human initial conditions
I_h0 = df.loc[0, 'total_cases']
E_h0 = I_h0 * 0.5
R_h0 = 0
S_h0 = N_h - E_h0 - I_h0 - R_h0

# mosquito initial conditions
T0 = temp_interp(0)
H0 = humid_interp(0)
R0 = precip_interp(0)
K0 = carrying_capacity(T0, H0, R0)

# estimate initial infected mosquitoes from human cases
a0 = biting_rate(T0)
b0 = prob_human_infection(T0)
I_m0 = max(10, I_h0 * N_h / (a0 * b0 * S_h0))
I_m0 = min(I_m0, 0.05 * K0)  # cap at 5% of carrying capacity
E_m0 = 2 * I_m0
S_m0 = max(0, K0 - E_m0 - I_m0)

y0 = [S_m0, E_m0, I_m0, S_h0, E_h0, I_h0, R_h0]

print(f"Initial conditions:")
print(f"  Humans: S={S_h0:.0f}, E={E_h0:.0f}, I={I_h0:.0f}, R={R_h0:.0f}")
print(f"  Mosquitoes: S={S_m0:.0f}, E={E_m0:.0f}, I={I_m0:.0f} (K={K0:.0f})")

# solve ODE ----
print("\nSolving ODE system...")
t_span = (0, n_weeks)
t_eval = np.arange(n_weeks)

sol = solve_ivp(
    sei_seir_model,
    t_span,
    y0,
    t_eval=t_eval,
    method='LSODA',     # automatically switches between stiff/non-stiff
    max_step=0.5,       # maximum step size
    rtol=1e-5,
    atol=1e-7
)

if not sol.success:
    print(f"Warning: {sol.message}")
else:
    print("Success!")

# extract results ----
S_m, E_m, I_m, S_h, E_h, I_h, R_h = sol.y

# evaluate ----
observed = df['total_cases'].values
predicted = I_h

r2 = r2_score(observed, predicted)
rmse = np.sqrt(mean_squared_error(observed, predicted))
mae = mean_absolute_error(observed, predicted)

print(f"\nModel Performance:")
print(f"  R² = {r2:.3f}")
print(f"  RMSE = {rmse:.1f}")
print(f"  MAE = {mae:.1f}")

# save results ----
results_df = pd.DataFrame({
    'week': np.arange(n_weeks),
    'observed': observed,
    'predicted': predicted,
    'S_h': S_h,
    'E_h': E_h,
    'I_h': I_h,
    'R_h': R_h,
    'S_m': S_m,
    'E_m': E_m,
    'I_m': I_m,
    'N_m': S_m + E_m + I_m,
    'K': [carrying_capacity(temp_interp(t), humid_interp(t), precip_interp(t)) for t in t_eval]
})
results_df.to_csv('results/seir_model_results.csv', index=False)

# visualizations ----
fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# plot 1: observed vs predicted
axes[0,0].plot(observed, 'o-', label='Observed', color='red', alpha=0.6, markersize=3)
axes[0,0].plot(predicted, '-', label='Predicted', color='blue', linewidth=2)
axes[0,0].set_xlabel('Week')
axes[0,0].set_ylabel('Cases')
axes[0,0].set_title(f'Dengue Cases\nR²={r2:.3f}, RMSE={rmse:.1f}')
axes[0,0].legend()
axes[0,0].grid(True, alpha=0.3)

# plot 2: human compartments
axes[0,1].plot(S_h, label='S_h', color='green', alpha=0.7)
axes[0,1].plot(E_h, label='E_h', color='orange', alpha=0.7)
axes[0,1].plot(I_h, label='I_h', color='red', alpha=0.7)
axes[0,1].plot(R_h, label='R_h', color='blue', alpha=0.7)
axes[0,1].set_xlabel('Week')
axes[0,1].set_ylabel('Population')
axes[0,1].set_title('Human Compartments')
axes[0,1].legend()
axes[0,1].grid(True, alpha=0.3)

# plot 3: mosquito compartments
axes[1,0].plot(S_m, label='S_m', color='green', alpha=0.7)
axes[1,0].plot(E_m, label='E_m', color='orange', alpha=0.7)
axes[1,0].plot(I_m, label='I_m', color='red', alpha=0.7)
K_vals = [carrying_capacity(temp_interp(t), humid_interp(t), precip_interp(t)) for t in t_eval]
axes[1,0].plot(K_vals, '--', label='Carrying Capacity', color='black', alpha=0.5)
axes[1,0].set_xlabel('Week')
axes[1,0].set_ylabel('Population')
axes[1,0].set_title('Mosquito Compartments')
axes[1,0].legend()
axes[1,0].grid(True, alpha=0.3)

# plot 4: total mosquito population vs carrying capacity
N_m = S_m + E_m + I_m
axes[1,1].plot(N_m, label='Total Mosquitoes', color='purple', linewidth=2)
axes[1,1].plot(K_vals, '--', label='Carrying Capacity K', color='black', linewidth=2)
axes[1,1].fill_between(range(n_weeks), 0, K_vals, alpha=0.2, color='gray')
axes[1,1].set_xlabel('Week')
axes[1,1].set_ylabel('Population')
axes[1,1].set_title('Mosquito Population vs Carrying Capacity')
axes[1,1].legend()
axes[1,1].grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('results/seir_model_results.png', dpi=300)
plt.show()

print("\nResults saved to results/seir_model_results.csv and .png")